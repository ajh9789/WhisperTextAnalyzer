## 📌 프로젝트 개요 
WhisperTextAnalyzer는 실시간 음성 스트림을 텍스트로 변환하고 감정 분석을 수행하는 End-to-End 파이프라인 시스템입니다.

- 클라이언트 브라우저에서 **Web Audio API (ScriptProcessorNode)**로 마이크 입력을 캡처하여 FastAPI 서버로 전송
- **FastAPI WebSocket 서버**가 오디오 데이터를 수신 후 Redis audio_queue에 저장
- **stt_worker (Celery Worker)**가 audio_queue 데이터를 가져와 **OpenAI Whisper 모델**로 STT (Speech-to-Text) 변환
- 텍스트를 Redis text_queue로 전달
- **analyzer_worker (Celery Worker)**가 text_queue의 텍스트를 **transformers 기반 감정 분석 모델**(`distilbert-base-uncased-finetuned-sst-2-english`)로 분석
- 분석 결과는 Redis PubSub의 result_channel로 publish
- **listener 서비스**가 result_channel을 구독하여 결과 및 통계 정보를 파일(`result_listener.log`) + 콘솔에 출력
- 최종적으로 사용자는 Web UI에서 실시간으로 자신의 음성 텍스트 + 감정 분석 결과를 확인 가능


## 🛠️ 시스템 아키텍처
````
Client (브라우저: Web Audio → WebSocket)
↓
FastAPI 서비스 (audio_queue로 Redis push)
↓
Redis (audio_queue → text_queue → PubSub result_channel)
↓
stt_worker (Celery + Whisper 모델 → text_queue로 push)
↓
analyzer_worker (Celery + transformers 감정 분석 → result_channel로 publish)
↓
listener (result_channel 구독 → 콘솔 + 파일로 출력)
````



---

## ⚙️ 주요 기술 스택
- FastAPI + WebSocket
- Web Audio API (ScriptProcessorNode 기반)
- Redis (Queue + Pub/Sub)
- Celery (비동기 Worker 관리)
- Whisper (STT 모델, OpenAI Whisper 기반)
- Huggingface Transformers (`distilbert-base-uncased-finetuned-sst-2-english` 감정 분석)
- Docker + Docker Compose

---

## 🧩 개발 중 겪었던 문제 및 해결 방법

### 1. Python whisper vs openai-whisper 혼용 문제
- 초기에는 **패키지 whisper**와 **모듈 whisper(openai-whisper)**가 혼용되어 충돌 발생
- 특히 **Celery worker의 -A 인자에서 worker 파일명과 whisper 패키지명이 충돌** → Celery app load 실패
- **핵심 해결**
  - worker 파일명을 `stt_worker.py`, `analyzer_worker.py` 등으로 명확하게 설정 (절대 whisper.py 쓰지 않음)
  - Celery 실행 시 `celery -A stt_worker:celery_app worker --concurrency=1 --pool=solo`로 정확하게 모듈 지정
- **추가 안전책**
  - 코드에서 import 혼동 방지를 위해 `import whisper as openai_whisper`로 통일

### 2. Windows 환경 개발 시 제한 사항

- Windows + Docker 환경에서 **Celery worker 컨테이너 비정상 종료, crash** 발생
- 원인: **Windows는 fork() 미지원 → spawn() 방식으로 불안정**
- 멀티 concurrency 설정 시 문제 심화 → 반드시 `--pool=solo` 설정 필요  
  → `--pool=solo`: **단일 프로세스, 단일 스레드로만 실행하도록 강제** (Windows 환경에서 안정성 확보)
- Docker에서는 기본적으로 **호스트 마이크 사용 불가**
- 해결:
  - `record` 서비스만 로컬 Python 프로세스로 실행
  - 나머지 서비스(`fastapi_service`, `stt_worker`, `redis`)는 Docker로 운영
  - 또는 Redis만 Docker, 나머지는 로컬로 조합 테스트

#### ✅ Windows vs Linux → Celery 멀티 프로세스 차이

| 시스템 | fork() 지원 | Celery 멀티프로세스 | 결과 |
|-------|-------------|---------------------|------|
| Linux, macOS | ✅ 지원 (`fork()`) | 정상 작동 | 문제 없음 |
| Windows | ❌ 미지원 → `spawn()` | 불안정 | worker crash, hang |

#### ✅ fork() vs spawn() 요약

| 방식 | 특징 | 비유 |
|------|------|------|
| **fork()** | 부모 메모리를 그대로 복제 → 빠르고 안정적 | 복사기로 즉시 복사 |
| **spawn()** | 새 프로세스로 시작 → RAM, CPU 추가 소모 | 새 컴퓨터에 프로그램 재설치 |

#### ✅ Windows에서 spawn()의 문제

- `spawn()`은 새로 Python interpreter + 모든 모듈 + celery context를 다시 로드 → **RAM, CPU 사용량 증가**
- Docker + Celery + Windows 조합에서 child process들이 redis, broker 연결 실패 → **죽음, hang, crash**
- 실질적으로 **Windows에서는 Celery 멀티 프로세스 사용 불가**

### 3. 리눅스 서버 (Azure Linux VM) 배포 시 어려움
- 리눅스는 윈도우와 달라 경로, 파일 권한 등에서 차이가 존재
- 예상치 못한 permission 문제, Redis 접속 문제 발생
- **해결**: Azure VM 환경 맞춰 Docker 재셋팅하고 FastAPI 서버, Redis 서버 따로 튜닝

### 4. STT 서비스의 샘플링 주파수 문제 (실시간 FastAPI 소켓 통신)

- Whisper 모델(STT)은 **16,000Hz (16kHz)** 샘플링을 요구
- 하지만 브라우저, 모바일, 디바이스 마이크의 기본 샘플링은 보통 **44,100Hz, 48,000Hz** 등으로 다양하여 **샘플링 불일치 문제가 발생**
- FastAPI WebSocket으로 실시간 스트림 연결 시 **서버에서 실시간으로 downsampling (샘플레이트 변환)**이 필요
- **변환 과정의 주요 문제점**
  - 실시간 스트림 데이터는 연속 버퍼로 들어와 **실시간 downsample이 까다로움**
  - Python `sounddevice`, `scipy.signal.resample_poly()` 등을 통해 변환 로직을 직접 구현
  - 데이터 지연(Latency)을 최소화하기 위해 **최적의 버퍼 크기**와 **변환 속도**를 지속적으로 튜닝
- **최종 해결 방법**
  - 클라이언트 → 서버 전달 직후 `resample_poly()`로 **44.1kHz → 16kHz** 변환
  - STT 모델로 전달 전 항상 **16kHz로 표준화**
  - 테스트 과정에서 최적 버퍼 크기와 처리 주기를 조정하여 **실시간성 + 안정성 모두 확보*

### 5. HTTPS 인증 관련 이슈 (브라우저 마이크 권한)
- 실서버 배포 시 HTTPS가 없으면 브라우저가 마이크 접근 차단
- Let's Encrypt로 무료 SSL 발급 시도했지만, 관리 복잡 + 시간 문제

### 6. ngrok으로 우회 테스트
- 간단히 `ngrok http 8000`을 사용해 HTTPS 우회
- **단점**: ngrok 무료 버전은 1시간마다 주소가 바뀜
- **장점**: 실시간 테스트, 모바일 접속, 다른 PC 접속 등 쉽게 해결 가능

---

## 🖼️ 최종 프로젝트 배포 구조
> 개발 중 `record_service`는 테스트용으로 사용했으나, 최종 배포에서는 제외

````
WhisperTextAnalyzer/
├── analyzer_worker/
│   ├── Dockerfile
│   ├── requirements.txt
│   └── worker.py
├── fastapi_service/
│   ├── Dockerfile
│   ├── requirements.txt
│   └── service.py
├── listener_service/
│   ├── Dockerfile
│   ├── requirements.txt
│   └── service.py
├── stt_worker/
│   ├── __init__.py
│   ├── Dockerfile
│   ├── requirements.txt
│   └── worker.py
├── .dockerignore
├── .gitignore
├── docker-compose.yml
├── README.md
└── requirements.txt
````


## ✨ 최종 소감
- **Python 환경 (Windows vs Linux)** 차이를 직접 경험하며 배웠음
- 실시간 WebSocket 오디오 스트림 처리의 어려움을 체험
- Whisper 모델이 기대하는 오디오 포맷(WAV, 16kHz, mono)을 맞추는 게 얼마나 까다로운지 이해
- 실서비스 배포까지 직접 다루면서 **Docker, Redis, Celery, Web Audio API** 전체 스택 경험 완료
- ngrok을 통한 간편 테스트 기법을 실무에서 익힘

---

# 📢 주의사항
- 본 프로젝트는 학습 및 데모용이며, 실제 상용 서비스 배포 시 HTTPS/인증/보안 설정이 필수입니다.
